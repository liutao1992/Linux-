### Linux下访问DNS服务
我们要访问DNS服务，就必须先知道DNS服务器的IP地址。Linux 使用/etc/resolv.conf文件来存放DNS服务器的IP地址。机器ernest-laptop 上，该文件的内容如下:

```bash
 #Generated by Network Manager
   nameserver 219.239.26.42
   nameserver 124.207.160.106
```

其中的两个IP地址分别是首选DNS服务器地址和备选DNS服务器 地址。文件中的注释语句“Generated by Network Manager”告诉我们，这 两个DNS服务器地址是由网络管理程序写入的。

Linux下一个常用的访问DNS服务器的客户端程序是host，比如下 面的命令是向首选DNS服务器219.239.26.42查询机器www.baidu.com的 IP地址:

```bash
liutao@liutao:/etc/apt$ host -t A www.baidu.com
www.baidu.com is an alias for www.a.shifen.com.
www.a.shifen.com has address 183.2.172.42
www.a.shifen.com has address 183.2.172.185
```

host命令的输出告诉我们，机器名www.baidu.com是 www.a.shifen.com.的别名，并且该机器名对应两个IP地址。host命令使 用DNS协议和DNS服务器通信，其-t选项告诉DNS协议使用哪种查询类型。我们这里使用的是A类型，即通过机器的域名获得其IP地址(但实 际上返回的资源记录中还包含机器的别名)。关于host命令的详细使用 方法，请参考其man手册。

### 使用tcpdump观察DNS通信过程

![这是图片](./image/截屏2024-06-20%2017.01.56.png "DNS通信过程")


让我们详细解析这个 `tcpdump` 抓包内容。以下是每个数据包的解释：

### 基本信息
```plaintext
tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
listening on ens33, link-type EN10MB (Ethernet), capture size 500 bytes
```
- **tcpdump: verbose output suppressed**：输出中省略了详细信息，可以使用 `-v` 或 `-vv` 来获取完整的协议解码。
- **listening on ens33**：正在监听网络接口 `ens33`。
- **link-type EN10MB (Ethernet)**：链路类型为以太网。
- **capture size 500 bytes**：每个数据包捕获的大小为 500 字节。

### 数据包 1
```plaintext
08:59:55.304160 IP ernest-laptop.44098 > dns.google.domain: 15162+ [1au] A? www.a.shifen.com. (45)
```
- **时间戳**：08:59:55.304160
- **IP**：协议类型为 IP。
- **源地址和端口**：ernest-laptop.44098
- **目标地址和端口**：dns.google.domain
- **查询 ID**：15162
- **标志**：`[1au]`，表示包含一个附加资源记录。
- **查询类型**：A 记录查询。
- **查询域名**：www.a.shifen.com
- **长度**：45 字节。

### 数据包 2
```plaintext
08:59:55.305595 IP ernest-laptop.44174 > dns.google.domain: 10350+ [1au] PTR? 8.8.8.8.in-addr.arpa. (49)
```
- **时间戳**：08:59:55.305595
- **IP**：协议类型为 IP。
- **源地址和端口**：ernest-laptop.44174
- **目标地址和端口**：dns.google.domain
- **查询 ID**：10350
- **标志**：`[1au]`，表示包含一个附加资源记录。
- **查询类型**：PTR 记录查询。
- **查询域名**：8.8.8.8.in-addr.arpa
- **长度**：49 字节。

### 数据包 3
```plaintext
08:59:55.347306 IP dns.google.domain > ernest-laptop.44174: 10350 1/0/1 PTR dns.google. (73)
```
- **时间戳**：08:59:55.347306
- **IP**：协议类型为 IP。
- **源地址和端口**：dns.google.domain
- **目标地址和端口**：ernest-laptop.44174
- **查询 ID**：10350
- **应答**：1 个回答，0 个权威应答，1 个附加记录。
- **应答记录**：PTR 记录，指向 dns.google
- **长度**：73 字节。

### 数据包 4
```plaintext
08:59:55.347847 IP ernest-laptop.53142 > dns.google.domain: 42722+ [1au] PTR? 108.42.168.192.in-addr.arpa. (56)
```
- **时间戳**：08:59:55.347847
- **IP**：协议类型为 IP。
- **源地址和端口**：ernest-laptop.53142
- **目标地址和端口**：dns.google.domain
- **查询 ID**：42722
- **标志**：`[1au]`，表示包含一个附加资源记录。
- **查询类型**：PTR 记录查询。
- **查询域名**：108.42.168.192.in-addr.arpa
- **长度**：56 字节。

### 数据包 5
```plaintext
08:59:55.383308 IP dns.google.domain > ernest-laptop.53142: 42722 NXDomain 0/0/1 (56)
```
- **时间戳**：08:59:55.383308
- **IP**：协议类型为 IP。
- **源地址和端口**：dns.google.domain
- **目标地址和端口**：ernest-laptop.53142
- **查询 ID**：42722
- **应答**：NXDomain（Non-Existent Domain，不存在的域名），0 个回答，0 个权威应答，1 个附加记录。
- **长度**：56 字节。

### 数据包 6
```plaintext
08:59:55.383461 IP ernest-laptop.53142 > dns.google.domain: 42722+ PTR? 108.42.168.192.in-addr.arpa. (45)
```
- **时间戳**：08:59:55.383461
- **IP**：协议类型为 IP。
- **源地址和端口**：ernest-laptop.53142
- **目标地址和端口**：dns.google.domain
- **查询 ID**：42722
- **查询类型**：PTR 记录查询。
- **查询域名**：108.42.168.192.in-addr.arpa
- **长度**：45 字节。

### 数据包 7
```plaintext
08:59:55.417631 IP dns.google.domain > ernest-laptop.53142: 42722 NXDomain 0/0/0 (45)
```
- **时间戳**：08:59:55.417631
- **IP**：协议类型为 IP。
- **源地址和端口**：dns.google.domain
- **目标地址和端口**：ernest-laptop.53142
- **查询 ID**：42722
- **应答**：NXDomain（Non-Existent Domain，不存在的域名），0 个回答，0 个权威应答，0 个附加记录。
- **长度**：45 字节。

### 数据包 8
```plaintext
08:59:55.418747 IP dns.google.domain > ernest-laptop.44098: 15162 2/0/1 A 183.2.172.185, A 183.2.172.42 (77)
```
- **时间戳**：08:59:55.418747
- **IP**：协议类型为 IP。
- **源地址和端口**：dns.google.domain
- **目标地址和端口**：ernest-laptop.44098
- **查询 ID**：15162
- **应答**：2 个回答，0 个权威应答，1 个附加记录。
- **应答记录**：A 记录，183.2.172.185 和 183.2.172.42
- **长度**：77 字节。

### 总结

这个抓包示例展示了从客户端向 DNS 服务器发送 DNS 查询和接收响应的过程。主要包括 A 记录和 PTR 记录的查询和响应：

1. 客户端发送 A 记录查询和 PTR 记录查询。
2. DNS 服务器返回 A 记录查询的结果（两个 IP 地址）和 PTR 记录的结果（有一个结果和 NXDomain）。
3. 重复的 PTR 查询表明客户端在收到 NXDomain 后再次尝试进行查询。

通过这些数据包的详细解析，可以帮助理解 DNS 查询和响应的工作机制，以及在实际网络环境中如何进行网络故障排除和性能分析。

